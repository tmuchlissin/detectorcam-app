{% extends "base.html" %} {% block content %}
<div class="p-8">
  <h2 class="text-2xl font-bold text-slate-800 mb-4 flex-shrink-0">
    View Detector Stream
  </h2>
  <div class="h-full flex flex-col">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow min-h-0">
      <div class="lg:col-span-2 bg-black rounded-xl flex flex-col p-2">
        {% if detector.running and detector.camera.status %}
        <div
          class="relative overflow-hidden rounded-lg w-full h-full"
          id="stream-container"
        >
          <img
            src="{{ url_for('detector.stream_detector', id=detector.id, tracking=tracking) }}"
            alt="Detector Stream"
            class="w-full h-full object-contain"
            id="camera-stream"
          />

          <div
            class="absolute top-3 left-3 flex items-center bg-red-600 text-white px-2.5 py-0.5 rounded-md text-xs font-bold z-10"
          >
            <div
              class="w-1.5 h-1.5 bg-white rounded-full mr-1.5 animate-pulse"
            ></div>
            LIVE
          </div>

          <div
            class="absolute top-3 right-3 bg-black/70 backdrop-blur-sm text-white px-3 py-2 rounded-lg text-xs font-mono z-10"
            id="fps-overlay"
          >
            <div class="flex flex-col gap-1">
              <div class="flex justify-between gap-3">
                <span class="text-slate-300">FPS:</span>
                <span class="text-green-400 font-bold" id="fps-value">0.0</span>
              </div>
              <div class="flex justify-between gap-3">
                <span class="text-slate-300">Inference:</span>
                <span class="text-blue-400 font-bold" id="inference-value"
                  >0.0ms</span
                >
              </div>
              <div class="flex justify-between gap-3">
                <span class="text-slate-300">Objects:</span>
                <span class="text-orange-400 font-bold" id="detections-value"
                  >0</span
                >
              </div>
            </div>
          </div>

          <div
            id="loading-indicator"
            class="absolute inset-0 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm hidden"
          >
            <div
              class="animate-spin rounded-full h-10 w-10 border-2 border-white/50 border-t-white"
            ></div>
          </div>

          <div
            id="error-message"
            class="absolute inset-0 flex items-center justify-center hidden"
          >
            <div class="text-center p-4">
              <p class="font-medium text-white">Stream unavailable</p>
              <p class="text-slate-300 text-sm">Retrying connection...</p>
              <p class="text-slate-300 text-sm mt-2">
                Try clicking refresh if stream video does not appear directly
              </p>
            </div>
          </div>
        </div>
        {% else %}
        <div
          class="flex-grow flex items-center justify-center bg-slate-100 rounded-lg text-center"
        >
          <div>
            <h4 class="text-lg font-semibold text-slate-700">
              Detector Offline
            </h4>
            <p class="text-slate-500 text-sm">
              The detector or its associated camera is not active.
            </p>
          </div>
        </div>
        {% endif %}
      </div>

      <div
        class="lg:col-span-1 bg-white p-6 rounded-xl border border-slate-200/80 shadow-sm flex flex-col gap-5"
      >
        <div>
          <h3 class="text-lg font-semibold text-slate-800 mb-4">
            Detector Details
          </h3>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Camera</span>
              <span class="font-medium text-slate-700 text-right"
                >{{detector.camera.type }} - {{detector.camera.location }}</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Model</span>
              <span class="font-medium text-slate-700"
                >{{ detector.model.model_name }}</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Status</span>
              <div class="flex items-center gap-2">
                <div
                  class="w-2 h-2 rounded-full {{ 'bg-green-500' if detector.running else 'bg-red-500' }}"
                ></div>
                <span
                  class="font-semibold {{ 'text-green-600' if detector.running else 'text-red-600' }}"
                >
                  {{ 'Running' if detector.running else 'Stopped' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        {% if detector.running and detector.camera.status %}
        <hr class="border-slate-200/80" />
        <div>
          <h4 class="text-sm font-semibold text-slate-800 mb-3">Mode</h4>
          <div class="flex items-center justify-between">
            <span class="text-slate-500 text-sm">Object Tracking</span>
            <label
              for="tracking-toggle"
              class="flex items-center cursor-pointer"
            >
              <div class="relative">
                <input
                  type="checkbox"
                  id="tracking-toggle"
                  class="sr-only"
                  {%
                  if
                  tracking
                  %}checked{%
                  endif
                  %}
                />
                <div class="block bg-slate-200 w-14 h-8 rounded-full"></div>
                <div
                  class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"
                ></div>
              </div>
            </label>
          </div>
        </div>
        {% endif %} {% if detector.running and detector.camera.status %}
        <hr class="border-slate-200/80" />
        <div>
          <h4 class="text-sm font-semibold text-slate-800 mb-3">Performance</h4>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Current FPS</span>
              <span class="font-bold text-green-600 font-mono" id="sidebar-fps"
                >0.0</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Avg Inference</span>
              <span
                class="font-bold text-blue-600 font-mono"
                id="sidebar-inference"
                >0.0ms</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Objects Detected</span>
              <span
                class="font-bold text-orange-600 font-mono"
                id="sidebar-detections"
                >0</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Status</span>
              <div class="flex items-center gap-2">
                <div
                  class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
                  id="status-indicator"
                ></div>
                <span
                  class="text-xs text-slate-600 font-medium"
                  id="status-text"
                  >Active</span
                >
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <hr class="border-slate-200/80" />
        <div class="flex flex-col gap-3">
          {% if detector.running and detector.camera.status %}
          <div class="grid grid-cols-2 gap-3">
            <button
              onclick="refreshStream()"
              class="flex w-full items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white py-2.5 text-sm font-semibold text-slate-700 transition-colors hover:bg-slate-50"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              Refresh
            </button>
            <button
              onclick="toggleFullscreen()"
              class="flex w-full items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white py-2.5 text-sm font-semibold text-slate-700 transition-colors hover:bg-slate-50"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                />
              </svg>
              Fullscreen
            </button>
          </div>
          <p class="text-slate-500 text-sm text-center">
            Try clicking refresh if stream video does not appear directly
          </p>
          {% endif %}
          <a
            href="{{ url_for('detector.main_detector') }}"
            class="flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 py-2.5 text-sm font-semibold text-white shadow-sm shadow-blue-500/20 transition-all hover:bg-blue-700 hover:shadow-md hover:shadow-blue-500/30"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"
              />
            </svg>
            Back to List
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const DETECTOR_ID = {{ detector.id }};
  let fpsUpdateInterval;
  let isTracking = {{ tracking|tojson }};

  // Auto-reconnect configuration
  const INITIAL_DELAY = 5000;
  const MAX_DELAY = 60000;
  const BACKOFF_FACTOR = 2;
  let currentDelay = INITIAL_DELAY;
  let reconnectTimer;

  document.addEventListener("DOMContentLoaded", function () {
    const streamImg = document.getElementById("camera-stream");
    const errorMessage = document.getElementById("error-message");
    const loadingIndicator = document.getElementById("loading-indicator");
    const trackingToggle = document.getElementById('tracking-toggle');

    if (streamImg) {
      streamImg.onload = function () {
        if (loadingIndicator) loadingIndicator.classList.add("hidden");
        if (errorMessage) errorMessage.classList.add("hidden");
        streamImg.style.opacity = "1";

        // Reset state if connection successful
        currentDelay = INITIAL_DELAY;
        if (reconnectTimer) clearTimeout(reconnectTimer);

        startFPSUpdates();
      };

      streamImg.onerror = function () {
        streamImg.style.opacity = "0";
        if (loadingIndicator) loadingIndicator.classList.add("hidden");
        stopFPSUpdates();

        // Display error message
        if (errorMessage) {
            errorMessage.classList.remove("hidden");
            errorMessage.querySelector('p.font-medium').textContent = "Stream Connection Lost";
            errorMessage.querySelector('p.text-sm').textContent = `Try again in ${currentDelay / 1000} seconds...`;
        }

        console.error(`Stream error. Retrying in ${currentDelay / 1000}s...`);

        // Retry schedule
        if (reconnectTimer) clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(() => {
            refreshStream(true);
            // Double the pause for the next try, until you reach the maximum limit.
            currentDelay = Math.min(currentDelay * BACKOFF_FACTOR, MAX_DELAY);
        }, currentDelay);
      };

      // Start stream if load page
      refreshStream();
    }

    if (trackingToggle) {
        trackingToggle.addEventListener('change', function() {
            isTracking = this.checked;
            refreshStream();
        });
    }
  });

  function startFPSUpdates() {
    stopFPSUpdates();
    updateFPSInfo();
    fpsUpdateInterval = setInterval(updateFPSInfo, 1000);
  }

  function stopFPSUpdates() {
    if (fpsUpdateInterval) {
      clearInterval(fpsUpdateInterval);
      fpsUpdateInterval = null;
    }
  }

  function updateFPSInfo() {
    fetch(`{{ url_for('detector.get_fps_info', id=detector.id) }}`)
      .then(response => response.json())
      .then(data => {
        const fpsValue = document.getElementById('fps-value');
        const inferenceValue = document.getElementById('inference-value');
        const detectionsValue = document.getElementById('detections-value');
        if (fpsValue) fpsValue.textContent = data.fps.toFixed(1);
        if (inferenceValue) inferenceValue.textContent = data.inference_time.toFixed(1) + 'ms';
        if (detectionsValue) detectionsValue.textContent = data.detections;

        const sidebarFps = document.getElementById('sidebar-fps');
        const sidebarInference = document.getElementById('sidebar-inference');
        const sidebarDetections = document.getElementById('sidebar-detections');
        if (sidebarFps) sidebarFps.textContent = data.fps.toFixed(1);
        if (sidebarInference) sidebarInference.textContent = data.inference_time.toFixed(1) + 'ms';
        if (sidebarDetections) sidebarDetections.textContent = data.detections;

        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        if (statusIndicator && statusText) {
          if (data.fps > 0) {
            statusIndicator.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
            statusText.textContent = 'Active';
            statusText.className = 'text-xs text-green-600 font-medium';
          } else {
            statusIndicator.className = 'w-2 h-2 rounded-full bg-yellow-500';
            statusText.textContent = 'Initializing...';
            statusText.className = 'text-xs text-yellow-600 font-medium';
          }
        }
      })
      .catch(error => {
        console.error('Error fetching FPS info:', error);
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        if (statusIndicator && statusText) {
          statusIndicator.className = 'w-2 h-2 rounded-full bg-red-500';
          statusText.textContent = 'Connection Error';
          statusText.className = 'text-xs text-red-600 font-medium';
        }
      });
  }

  function refreshStream(isRetry = false) {
    const streamImg = document.getElementById("camera-stream");
    if (!streamImg) return;

    if (!isRetry) {
        currentDelay = INITIAL_DELAY;
        if (reconnectTimer) clearTimeout(reconnectTimer);
    }

    console.log("Attempting to load stream. Tracking:", isTracking);
    document.getElementById("loading-indicator")?.classList.remove("hidden");
    document.getElementById("error-message")?.classList.add("hidden");

    stopFPSUpdates();

    const baseUrl = `{{ url_for('detector.stream_detector', id=detector.id) }}?tracking=${isTracking}`;
    streamImg.src = baseUrl + "&t=" + new Date().getTime();
  }

  function toggleFullscreen() {
    const streamContainer = document.getElementById("stream-container");
    if (streamContainer) {
      if (!document.fullscreenElement) {
        streamContainer.requestFullscreen().catch((err) => {
          console.error(`Error attempting to enable fullscreen: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    }
  }

  window.addEventListener('beforeunload', function() {
    stopFPSUpdates();
    if (reconnectTimer) clearTimeout(reconnectTimer);
  });
</script>
<style>
  input:checked ~ .dot {
    transform: translateX(100%);
    background-color: #4a90e2;
  }
</style>
{% endblock %}
